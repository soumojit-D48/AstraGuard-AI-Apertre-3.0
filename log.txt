============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\PURVANSH JOSHI\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
rootdir: D:\Elite_Coders\AstraGuard-AI
configfile: pyproject.toml
plugins: anyio-4.12.0, langsmith-0.5.1, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 19 items

tests/test_core_circuit_breaker.py::TestCircuitBreakerMetrics::test_initialization PASSED [  5%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_initialization PASSED [ 10%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_successful_call PASSED [ 15%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_failed_call_triggers_open PASSED [ 21%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_open_circuit_fails_fast PASSED [ 26%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_open_circuit_uses_fallback PASSED [ 31%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_recovery_timeout_transition_to_half_open FAILED [ 36%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_half_open_success_recovery PASSED [ 42%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_half_open_failure_back_to_open PASSED [ 47%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_reset_functionality PASSED [ 52%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_expected_exceptions_only PASSED [ 57%]
tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_get_metrics_snapshot PASSED [ 63%]
tests/test_core_circuit_breaker.py::TestCircuitBreakerRegistry::test_register_and_get PASSED [ 68%]
tests/test_core_circuit_breaker.py::TestCircuitBreakerRegistry::test_get_all PASSED [ 73%]
tests/test_core_circuit_breaker.py::TestCircuitBreakerRegistry::test_get_metrics_all PASSED [ 78%]
tests/test_core_circuit_breaker.py::TestGlobalRegistry::test_global_register_and_get PASSED [ 84%]
tests/test_core_circuit_breaker.py::TestCircuitOpenError::test_error_initialization PASSED [ 89%]
tests/test_core_circuit_breaker.py::TestCircuitOpenError::test_error_default_state PASSED [ 94%]
tests/test_core_circuit_breaker.py::TestConcurrentCalls::test_concurrent_calls_thread_safety PASSED [100%]

================================== FAILURES ===================================
______ TestCircuitBreaker.test_recovery_timeout_transition_to_half_open _______

self = <test_core_circuit_breaker.TestCircuitBreaker object at 0x000001E90E1238A0>
breaker = <core.circuit_breaker.CircuitBreaker object at 0x000001E90E211250>

    @pytest.mark.asyncio
    async def test_recovery_timeout_transition_to_half_open(self, breaker):
        """Test transition from OPEN to HALF_OPEN after recovery timeout"""
        # Force circuit to OPEN
        breaker._transition_to_open()
        assert breaker.is_open
    
        # Wait for recovery timeout
        await asyncio.sleep(1.1)
    
        mock_func = AsyncMock(return_value="success")
    
        # Should transition to HALF_OPEN and succeed
>       result = await breaker.call(mock_func)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_core_circuit_breaker.py:149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <core.circuit_breaker.CircuitBreaker object at 0x000001E90E211250>
func = <AsyncMock id='2100475637312'>, fallback = None, args = (), kwargs = {}

    async def call(
        self,
        func: Callable,
        *args,
        fallback: Optional[Callable] = None,
        **kwargs
    ) -> Any:
        """
        Execute function through circuit breaker.
    
        Args:
            func: Async function to call
            *args: Positional arguments
            fallback: Fallback function if circuit is open
            **kwargs: Keyword arguments
    
        Returns:
            Function result or fallback result
    
        Raises:
            CircuitOpenError: If circuit is open and no fallback provided
        """
        with self._lock:
            # Transition from OPEN to HALF_OPEN if recovery timeout exceeded
            if self.is_open and self._should_attempt_recovery():
                self._transition_to_half_open()
    
            # Fail fast if still open
            if self.is_open:
                if fallback:
                    logger.warning(
                        f"Circuit '{self.name}' is OPEN, using fallback"
                    )
                    return await fallback(*args, **kwargs)
>               raise CircuitOpenError(
                    f"Circuit breaker '{self.name}' is OPEN. "
                    f"Service recovery in ~{self.recovery_timeout}s",
                    state=CircuitState.OPEN
                )
E               core.circuit_breaker.CircuitOpenError: Circuit breaker 'test_breaker' is OPEN. Service recovery in ~1s

core\circuit_breaker.py:160: CircuitOpenError
------------------------------ Captured log call ------------------------------
ERROR    core.circuit_breaker:circuit_breaker.py:227 Circuit 'test_breaker' OPENED after 0 failures
=========================== short test summary info ===========================
FAILED tests/test_core_circuit_breaker.py::TestCircuitBreaker::test_recovery_timeout_transition_to_half_open
======================== 1 failed, 18 passed in 1.35s =========================
